var container=document.getElementById("game");var canvas=document.getElementById("canvas");var context=canvas.getContext("2d");var CONFIG={status:"start",level:1,totalLevel:6,numPerLine:7,canvasPadding:30,bulletSize:10,bulletSpeed:10,enemySpeed:2,enemySize:50,enemyGap:10,enemyIcon:"./img/enemy.png",enemyBoomIcon:"./img/boom.png",enemyDirection:"right",planeSpeed:5,planeSize:{width:60,height:100},planeIcon:"./img/plane.png"};var GAME={init:function(opts){this.status=CONFIG.status;this.level=CONFIG.level;this.totalScore=0;this.bindEvent()},bindEvent:function(){var self=this;var playBtn=document.querySelector(".js-play");playBtn.onclick=function(){self.play()}},setStatus:function(status){this.status=status;container.setAttribute("data-status",status)},play:function(){this.setStatus("playing");this.plane=new Plane;this.plane.createPlane();this.monster=[];this.totalMonsterNum=this.level*CONFIG.numPerLine;this.monsterNum=this.level*CONFIG.numPerLine;for(var i=0;i<this.level;i++){for(var j=0;j<CONFIG.numPerLine;j++){var monster=new Monster;monster.y+=i*(monster.blank+monster.height);monster.x+=j*(monster.blank+monster.width);monster.createMonster();this.monster.push(monster)}}this.currentFrame=0;bindKeyEvent();move()},start:function(){this.level=CONFIG.level;this.totalScore=0;this.setStatus("start");this.bindEvent()},failed:function(){var self=this;this.setStatus("failed");var score=document.querySelector(".score");score.textContent=GAME.totalScore;var restartBtn=document.querySelectorAll(".js-replay");restartBtn[0].onclick=function(){self.start()}},success:function(){var self=this;this.setStatus("success");var nextLevel=document.querySelector(".game-next-level");nextLevel.textContent="下一关卡："+this.level;var nextBtn=document.querySelector(".js-next");nextBtn.onclick=function(){self.play()}},allSuccess:function(){var self=this;this.setStatus("all-success");var restartBtn=document.querySelectorAll(".js-replay");restartBtn[1].onclick=function(){self.start()}}};GAME.init();function Plane(){this.x=canvas.width/2-CONFIG.planeSize.width/2;this.y=canvas.height-CONFIG.canvasPadding-CONFIG.planeSize.height;this.width=CONFIG.planeSize.width;this.height=CONFIG.planeSize.height;this.step=CONFIG.planeSpeed;this.direction=null;this.src=CONFIG.planeIcon;this.bulletDistance=CONFIG.bulletSpeed;this.bullets=[]}Plane.prototype.createPlane=function(){var img=new Image;img.src=this.src;var imgX=this.x;var imgY=this.y;var imgWidth=this.width;var imgHeight=this.height;img.onload=function(){context.drawImage(img,imgX,imgY,imgWidth,imgHeight)};this.img=img};Plane.prototype.movePlane=function(){var moveRightSide=canvas.width-CONFIG.planeSize.width-CONFIG.canvasPadding;if(this.direction==="right"&&this.x<moveRightSide){this.x+=this.step}else if(this.direction==="left"&&this.x>CONFIG.canvasPadding){this.x-=this.step}};Plane.prototype.autoChangeBullet=function(i){this.bullets[i].beginY-=this.bulletDistance};function Monster(){this.x=CONFIG.canvasPadding;this.y=CONFIG.canvasPadding;this.width=CONFIG.enemySize;this.height=CONFIG.enemySize;this.step=CONFIG.enemySpeed;this.blank=CONFIG.enemyGap;this.time=0;this.direction=CONFIG.enemyDirection;this.status="alive";this.src=CONFIG.enemyIcon;this.boomSrc=CONFIG.enemyBoomIcon;this.boomFrame}Monster.prototype.createMonster=function(){var img=new Image;img.src=this.src;var imgX=this.x;var imgY=this.y;var imgWidth=this.width;var imgHeight=this.height;img.onload=function(){context.drawImage(img,imgX,imgY,imgWidth,imgHeight)};this.img=img};Monster.prototype.autoMoveMonster=function(direction){switch(direction){case"right":this.x+=this.step;break;case"left":this.x-=this.step;break}};function bindKeyEvent(){document.onkeydown=function(e){switch(e.keyCode){case 37:GAME.plane.direction="left";GAME.plane.movePlane();break;case 39:GAME.plane.direction="right";GAME.plane.movePlane();break;case 32:var bullet={beginX:GAME.plane.x+GAME.plane.width/2,beginY:GAME.plane.y};GAME.plane.bullets.push(bullet);break}};document.onkeyup=function(e){switch(e.keyCode){case 37:GAME.plane.direction=null;break;case 39:GAME.plane.direction=null;break}}}function drawLine(x,y,distance){context.strokeStyle="white";context.beginPath();context.moveTo(x,y);context.lineTo(x,y+distance);context.stroke()}function punchBoom(target,currentFrame){for(var k=0,len=GAME.plane.bullets.length;k<len;k++){if(GAME.plane.bullets[k].beginX>target.x&&GAME.plane.bullets[k].beginX<target.x+target.width&&GAME.plane.bullets[k].beginY+GAME.plane.bulletDistance<target.y+target.height){target.status="dying";var img=new Image;img.src=target.boomSrc;target.img=img;GAME.plane.bullets.splice(k,1);var boomFrame=currentFrame;return boomFrame}}}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/30)};function move(){context.clearRect(0,0,canvas.width,canvas.height);context.drawImage(GAME.plane.img,GAME.plane.x,GAME.plane.y,GAME.plane.width,GAME.plane.height);for(var k=0,len=GAME.plane.bullets.length;k<len;k++){drawLine(GAME.plane.bullets[k].beginX,GAME.plane.bullets[k].beginY,GAME.plane.bulletDistance);GAME.plane.autoChangeBullet(k);if(GAME.plane.bullets[k].beginY<=0){GAME.plane.bullets.shift();break}}for(var i=0;i<GAME.monsterNum;i++){if(GAME.monster[i].status==="alive"){GAME.monster[i].boomFrame=punchBoom(GAME.monster[i],GAME.currentFrame)}if(GAME.monster[i].status==="dying"){switch(GAME.currentFrame){case GAME.monster[i].boomFrame+1:GAME.monster[i].x+=20;GAME.monster[i].y+=20;GAME.monster[i].width=10;GAME.monster[i].height=10;break;case GAME.monster[i].boomFrame+2:GAME.monster[i].x-=10;GAME.monster[i].y-=10;GAME.monster[i].width=30;GAME.monster[i].height=30;break;case GAME.monster[i].boomFrame+3:GAME.monster[i].x-=10;GAME.monster[i].y-=10;GAME.monster[i].width=50;GAME.monster[i].height=50;break;case GAME.monster[i].boomFrame+4:GAME.monster[i].status="dead";break}}}for(var i=0;i<GAME.monsterNum;i++){if(GAME.monster[i].status==="dead"){GAME.monster.splice(i,1);GAME.monsterNum--}}for(var i=0;i<GAME.monsterNum;i++){if(GAME.monster[i].x<30){for(var j=0;j<GAME.monsterNum;j++){GAME.monster[j].direction="right";GAME.monster[j].y+=50}break}else if(GAME.monster[i].x>620){for(var j=0;j<GAME.monsterNum;j++){GAME.monster[j].direction="left";GAME.monster[j].y+=50}break}}for(var i=0;i<GAME.monsterNum;i++){GAME.monster[i].autoMoveMonster(GAME.monster[i].direction);context.drawImage(GAME.monster[i].img,GAME.monster[i].x,GAME.monster[i].y,GAME.monster[i].width,GAME.monster[i].height)}context.font="bold 18px Arial";context.fillStyle="white";var score=GAME.totalScore+GAME.totalMonsterNum-GAME.monsterNum;context.fillText("分数："+score,20,20);GAME.currentFrame++;var globalID=requestAnimationFrame(move);if(GAME.monster.length===0){cancelAnimationFrame(globalID);context.clearRect(0,0,canvas.width,canvas.height);if(GAME.level<CONFIG.totalLevel){GAME.level+=1;GAME.totalScore=score;GAME.success()}else if(GAME.level===CONFIG.totalLevel){GAME.totalScore=score;GAME.allSuccess()}}else if(GAME.monster[GAME.monsterNum-1].y>420){cancelAnimationFrame(globalID);context.clearRect(0,0,canvas.width,canvas.height);GAME.totalScore=score;GAME.failed()}}